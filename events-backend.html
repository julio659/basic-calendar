<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BASIC Calendar — Backend (Simplified + All-day + Secured)</title>
<style>
  :root{
    --bg:#0b1324; --card:#121a31; --ink:#e8eefc; --muted:#9fb0d3;
    --accent:#6cc2ff; --ok:#47d17a; --warn:#ffb454; --danger:#ff6b6b;
    --line:#22325e; --soft:#0f1a33; --radius:14px; --shadow:0 12px 36px rgba(0,0,0,.30)
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b1324 0%,#0e1a34 100%);color:var(--ink);
       font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{position:sticky;top:0;z-index:5;background:rgba(11,19,36,.85);backdrop-filter:saturate(160%) blur(10px);
         border-bottom:1px solid #1e2a4a}
  .wrap{max-width:1100px;margin:auto;padding:18px}
  h1{margin:0 0 4px;font-weight:800}
  .subtitle{color:var(--muted)}
  .grid{display:grid;gap:16px}
  .two{grid-template-columns:1.1fr .9fr}
  @media (max-width:1024px){.two{grid-template-columns:1fr}}

  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
  .pad{padding:16px}
  label{display:block;font-weight:700;margin:10px 0 6px}
  input, select, textarea{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #2c3e6a;background:var(--soft);color:var(--ink)}
  textarea{min-height:100px}
  .split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .muted{color:var(--muted)}
  .note{font-size:13px;color:var(--muted);margin-top:8px}

  .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
  button{border:0;border-radius:999px;padding:10px 16px;font-weight:800;cursor:pointer}
  .primary{background:var(--accent);color:#051127}
  .ok{background:var(--ok);color:#062616}
  .warn{background:var(--warn);color:#3a2200}
  .danger{background:var(--danger);color:#2b0707}
  .ghost{background:var(--soft);color:var(--ink);border:1px solid #2c3e6a}

  .list{display:grid;gap:10px}
  .event-item{display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center;background:#101a34;border:1px solid #22325e;border-radius:12px;padding:10px}
  .event-item img{width:56px;height:56px;object-fit:cover;border-radius:10px}
  .pill{font-size:12px;background:#0f284d;color:#b9d4ff;border:1px solid #214a89;padding:2px 8px;border-radius:999px}
  .mini{font-size:12px;color:var(--muted)}

  details.more summary{cursor:pointer;user-select:none;margin:14px 0 0}
  details.more .row{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
  .kpi{font-weight:800}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>BASIC Calendar — Backend</h1>
    <div class="subtitle">Friendly editor for seniors. Add / edit locally, then <b>Publish to Cloud</b> (admin code required).</div>
  </div>
</header>

<div class="wrap grid two">
  <!-- LEFT: Form -->
  <section class="card pad">
    <h2>Event editor</h2>

    <label>Title *</label>
    <input id="title" placeholder="e.g., Community Movie Night" />

    <div class="split">
      <div>
        <label>Category</label>
        <input id="category" placeholder="Workshop, Fundraiser" />
      </div>
      <div>
        <label>Location</label>
        <input id="location" placeholder="Address or place name" />
      </div>
    </div>

    <label>Description</label>
    <textarea id="description" placeholder="Write details here. Line breaks are preserved on the website."></textarea>

    <div class="split">
      <div>
        <label>
          <input type="checkbox" id="allDay" /> All-day
        </label>
      </div>
      <div>
        <label>RSVP / Ticket URL</label>
        <input id="rsvp" placeholder="https://…" />
      </div>
    </div>

    <div class="split" id="timeRow">
      <div>
        <label>Start date & time *</label>
        <input id="start" type="datetime-local" />
      </div>
      <div>
        <label>End date & time</label>
        <input id="end" type="datetime-local" />
      </div>
    </div>

    <div class="split">
      <div>
        <label>Image (URL)</label>
        <input id="image" placeholder="https://…/photo.jpg" />
      </div>
      <div>
        <label>Video (YouTube/Vimeo URL)</label>
        <input id="video" placeholder="https://youtu.be/… or https://vimeo.com/…" />
      </div>
    </div>

    <label>Attachments (comma-separated URLs – “url|nice label” optional)</label>
    <input id="attachments" placeholder="https://site.com/flyer.pdf|Event flyer, https://…/agenda.docx" />

    <details class="more">
      <summary>Repeating (optional)</summary>
      <div class="split">
        <div>
          <label>Frequency</label>
          <select id="freq">
            <option value="none">Does not repeat</option>
            <option value="DAILY">Daily</option>
            <option value="WEEKLY">Weekly</option>
            <option value="MONTHLY">Monthly</option>
            <option value="YEARLY">Yearly</option>
          </select>
        </div>
        <div>
          <label>Every…</label>
          <input id="interval" type="number" value="1" min="1" />
        </div>
      </div>
      <div class="split">
        <div>
          <label>Days (for WEEKLY) – MO,TU,WE,TH,FR,SA,SU</label>
          <input id="byday" placeholder="WE,FR" />
        </div>
        <div>
          <label>Until (end date)</label>
          <input id="until" type="date" />
        </div>
      </div>
      <div class="note">Uses iCalendar RRULE (kept simple).</div>
    </details>

    <!-- Primary actions (simplified) -->
    <div class="actions">
      <button class="primary" id="saveLocal">Save (Local)</button>
      <button class="ok" id="loadCloud">Load from Cloud</button>
      <button class="ok" id="publish">Publish to Cloud</button>
      <button class="danger" id="wipeCloud">Delete from Cloud</button>
    </div>

    <!-- Secondary -->
    <div class="actions">
      <button class="ghost" id="newEvent">New Event</button>
      <button class="ghost" id="changeCode">Change Admin Code</button>
      <button class="warn" id="clearAll">Clear Local</button>
    </div>

    <details class="more">
      <summary>More (exports)</summary>
      <div class="row">
        <button class="ghost" id="exportJson">Export JSON</button>
        <button class="ghost" id="exportIcs">Export ICS</button>
      </div>
    </details>

    <div class="note">
      Tip: Save multiple items locally, then publish once. Local items: <span class="kpi" id="count">0</span>
    </div>
  </section>

  <!-- RIGHT: Local list -->
  <section class="card pad">
    <h2>Local events</h2>
    <div id="list" class="list"></div>
    <div class="note">To remove an event from the public calendar: <b>Load from Cloud → delete locally → Publish to Cloud</b>.</div>
  </section>
</div>

<!-- Firebase v10 CDN -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script>
  /* ===== 1) Your Firebase config (as shared) ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyBUWTNk3fhYSY6hAgiuaLcThzy_xp1EN-c",
    authDomain: "basic-calendar-6404a.firebaseapp.com",
    projectId: "basic-calendar-6404a",
    storageBucket: "basic-calendar-6404a.firebasestorage.app",
    messagingSenderId: "714238179784",
    appId: "1:714238179784:web:d26b77c0a4a6f7c8db68fd"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const COL = db.collection('basic_calendar');

  /* ===== 2) Runtime Admin Code (never store in repo) ===== */
  let ADMIN_CODE = sessionStorage.getItem('BASIC_ADMIN_CODE') || '';
  function ensureAdminCode(force=false){
    if(force) { sessionStorage.removeItem('BASIC_ADMIN_CODE'); ADMIN_CODE=''; }
    if(!ADMIN_CODE){
      const input = prompt('Enter Admin Code to enable cloud changes:') || '';
      ADMIN_CODE = input.trim();
      if(ADMIN_CODE) sessionStorage.setItem('BASIC_ADMIN_CODE', ADMIN_CODE);
    }
    return !!ADMIN_CODE;
  }

  /* ===== 3) State & helpers ===== */
  const $=s=>document.querySelector(s);
  const LS='basic_events_v3';
  const load=()=>{try{return JSON.parse(localStorage.getItem(LS))||[]}catch{return []}};
  const save=v=>{localStorage.setItem(LS,JSON.stringify(v)); updateCount();}
  let EVENTS = load();
  let EDIT_INDEX = -1;

  function updateCount(){ $('#count').textContent = (EVENTS||[]).length; }
  function iso(s){ return s; } // datetime-local is already ISO-ish
  function rrule(){
    const f=$('#freq').value; if(f==='none') return '';
    const parts=[`FREQ=${f}`];
    const i=parseInt($('#interval').value||'1',10); if(i>1) parts.push(`INTERVAL=${i}`);
    const d=$('#byday').value.replace(/\s+/g,''); if(d) parts.push(`BYDAY=${d}`);
    const u=$('#until').value; if(u) parts.push(`UNTIL=${u.replace(/-/g,'')}T235959Z`);
    return parts.join(';');
  }
  function getForm(){
    const allDay = $('#allDay').checked;
    const startVal = $('#start').value;
    let endVal = $('#end').value || startVal;
    if(allDay){
      // All-day events: normalize to 00:00 → 23:59 same day
      const d = new Date(startVal || Date.now());
      const y=d.getFullYear(), m=('0'+(d.getMonth()+1)).slice(-2), da=('0'+d.getDate()).slice(-2);
      const dayStart = `${y}-${m}-${da}T00:00`;
      const dayEnd   = `${y}-${m}-${da}T23:59`;
      return baseEvent(dayStart, dayEnd, true);
    }
    return baseEvent(startVal, endVal, false);

    function baseEvent(start, end, allDayFlag){
      return {
        id: (EDIT_INDEX>-1 && EVENTS[EDIT_INDEX])? EVENTS[EDIT_INDEX].id : ('ev_'+Date.now()),
        title: $('#title').value.trim(),
        category: $('#category').value.trim(),
        description: $('#description').value,
        start: iso(start),
        end: iso(end),
        allDay: !!allDayFlag,
        location: $('#location').value.trim(),
        rsvp: $('#rsvp').value.trim(),
        image: $('#image').value.trim(),
        video: $('#video').value.trim(),
        attachments: $('#attachments').value.split(',').map(s=>s.trim()).filter(Boolean),
        rrule: rrule()
      };
    }
  }
  function setForm(e={}){
    const f=(id,val)=>{ const el=document.getElementById(id); if(el) el.value = val||''; };
    f('title', e.title); f('category', e.category); f('description', e.description);
    f('start', e.start); f('end', e.end); f('location', e.location);
    f('rsvp', e.rsvp); f('image', e.image); f('video', e.video);
    document.getElementById('attachments').value = (e.attachments||[]).join(', ');
    // Repeats
    document.getElementById('freq').value = (e.rrule? (e.rrule.match(/FREQ=([A-Z]+)/)||[])[1] : 'none') || 'none';
    document.getElementById('interval').value = (e.rrule? (e.rrule.match(/INTERVAL=(\d+)/)||[])[1] : 1) || 1;
    document.getElementById('byday').value = (e.rrule? (e.rrule.match(/BYDAY=([A-Z,]+)/)||[])[1] : '') || '';
    const until = (e.rrule? (e.rrule.match(/UNTIL=(\d{8})/)||[])[1] : '') || '';
    document.getElementById('until').value = until? `${until.slice(0,4)}-${until.slice(4,6)}-${until.slice(6,8)}` : '';

    // All-day
    const isAll = !!e.allDay;
    document.getElementById('allDay').checked = isAll;
    toggleAllDay(isAll);
  }

  function toggleAllDay(checked){
    const row = document.getElementById('timeRow');
    if(checked){
      // Switch inputs to just date pickers visually? Keep datetime-local but hide times.
      row.style.opacity = .6;
    } else {
      row.style.opacity = 1;
    }
  }
  document.getElementById('allDay').addEventListener('change', (e)=>toggleAllDay(e.target.checked));

  function render(){
    updateCount();
    const box=$('#list'); box.innerHTML='';
    EVENTS
      .slice()
      .sort((a,b)=>new Date(a.start)-new Date(b.start))
      .forEach((e,i)=>{
        const row=document.createElement('div'); row.className='event-item';
        row.innerHTML=`
          <img src="${e.image||('https://picsum.photos/seed/'+encodeURIComponent(e.title||'event')+'/120/120')}" alt="">
          <div>
            <div><strong>${e.title||'Untitled'}</strong> <span class="pill">${e.category||'General'}</span></div>
            <div class="mini">${formatRange(e)}</div>
            <div class="mini">${e.location||''}</div>
          </div>
        `;
        const btns=document.createElement('div'); btns.style.display='flex'; btns.style.gap='8px';

        const edit=document.createElement('button'); edit.className='ghost'; edit.textContent='Edit';
        edit.onclick=()=>{ EDIT_INDEX=i; setForm(e); window.scrollTo({top:0, behavior:'smooth'}); };

        const dup=document.createElement('button'); dup.className='ghost'; dup.textContent='Duplicate';
        dup.onclick=()=>{ const c={...e,id:'ev_'+Date.now()}; EVENTS.push(c); save(EVENTS); render(); };

        const del=document.createElement('button'); del.className='danger'; del.textContent='Delete';
        del.onclick=()=>{ if(confirm(`Delete “${e.title||'event'}” locally?`)){ EVENTS.splice(i,1); save(EVENTS); render(); } };

        btns.append(edit, dup, del); row.appendChild(btns); box.appendChild(row);
      });
  }

  function formatRange(e){
    const A=new Date(e.start), B=new Date(e.end||e.start);
    if(e.allDay){
      return `${A.toLocaleDateString([], {weekday:'short', month:'short', day:'numeric'})} (all-day)`;
    }
    const same = A.toDateString()===B.toDateString();
    return same
      ? `${A.toLocaleDateString([], {weekday:'short', month:'short', day:'numeric'})} • ${A.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'})}–${B.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'})}`
      : `${A.toLocaleString([], {dateStyle:'medium', timeStyle:'short'})} – ${B.toLocaleString([], {dateStyle:'medium', timeStyle:'short'})}`;
  }

  function escapeICS(s){return String(s).replace(/[\\;,\n]/g, m => ({"\\":"\\\\",";":"\\;",",":"\\,","\n":"\\n"}[m]));}
  function toICS(list){
    const lines=[`BEGIN:VCALENDAR`,`VERSION:2.0`,`PRODID:-//BASIC//Calendar//EN`];
    list.forEach(ev=>{
      lines.push('BEGIN:VEVENT');
      lines.push('UID:'+ev.id);
      lines.push('SUMMARY:'+escapeICS(ev.title||''));
      if(ev.description) lines.push('DESCRIPTION:'+escapeICS(ev.description));
      if(ev.location) lines.push('LOCATION:'+escapeICS(ev.location));
      if(ev.allDay){
        // All-day ICS uses VALUE=DATE and DTEND is exclusive (next day)
        const s=new Date(ev.start);
        const e=new Date(ev.end||ev.start);
        const pad=n=>String(n).padStart(2,'0');
        const d2=(d)=>`${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}`;
        e.setDate(s.getDate()+1); // next day
        lines.push(`DTSTART;VALUE=DATE:${d2(s)}`);
        lines.push(`DTEND;VALUE=DATE:${d2(e)}`);
      }else{
        if(ev.start) lines.push('DTSTART:'+new Date(ev.start).toISOString().replace(/[-:]/g,'').split('.')[0]+'Z');
        if(ev.end)   lines.push('DTEND:'+new Date(ev.end).toISOString().replace(/[-:]/g,'').split('.')[0]+'Z');
      }
      if(ev.rrule) lines.push('RRULE:'+ev.rrule);
      lines.push('END:VEVENT');
    });
    lines.push('END:VCALENDAR');
    return lines.join('\n');
  }

  /* ===== 4) Buttons ===== */
  document.getElementById('newEvent').onclick=()=>{ EDIT_INDEX=-1; setForm({}); };

  document.getElementById('saveLocal').onclick=()=>{
    const ev=getForm();
    if(!ev.title || !ev.start){ alert('Title and Start are required.'); return; }
    if(!ev.end){ ev.end = ev.start; }
    if(EDIT_INDEX>-1){ EVENTS[EDIT_INDEX]=ev; EDIT_INDEX=-1; }
    else EVENTS.push(ev);
    save(EVENTS); render();
  };

  document.getElementById('loadCloud').onclick=async()=>{
    try{
      const doc=await COL.doc('live').get();
      const data=doc.exists ? (doc.data()||{}) : {};
      const list=data.events||[];
      if(!list.length){ if(confirm('No events found in cloud. Replace your local list with empty?')){ EVENTS=[]; save(EVENTS); render(); } return; }
      if(confirm(`Load ${list.length} event(s) from cloud and replace your local list?`)){
        EVENTS = list;
        save(EVENTS); render();
      }
    }catch(err){
      console.error('[Load] error', err);
      alert(`Load failed: ${err.code||'unknown'}\n${err.message||''}`);
    }
  };

  document.getElementById('publish').onclick=async()=>{
    if(!EVENTS.length){ if(!confirm('You have 0 local events. Publish anyway (this will clear public list)?')) return; }
    if(!ensureAdminCode()) return;
    const payload = { events: EVENTS, updated: Date.now(), adminCode: ADMIN_CODE };
    try{
      await COL.doc('live').set(payload);
      alert('Published! Public calendar will update automatically.');
    }catch(err){
      console.error('[Publish] error', err);
      alert(`Publish failed: ${err.code||'unknown'}\n${err.message||''}`);
      if(err.code==='permission-denied'){ ensureAdminCode(true); }
    }
  };

  document.getElementById('wipeCloud').onclick=async()=>{
    if(!confirm('Delete ALL events from the public calendar? This can be undone by publishing again.')) return;
    if(!ensureAdminCode()) return;
    const payload={ events: [], updated: Date.now(), adminCode: ADMIN_CODE };
    try{
      await COL.doc('live').set(payload);
      alert('Cloud list cleared.');
    }catch(err){
      console.error('[Delete cloud] error', err);
      alert(`Delete failed: ${err.code||'unknown'}\n${err.message||''}`);
      if(err.code==='permission-denied'){ ensureAdminCode(true); }
    }
  };

  document.getElementById('changeCode').onclick=()=>{ ensureAdminCode(true); alert('Admin code cleared. Click a cloud action to enter the new code.'); };

  document.getElementById('clearAll').onclick=()=>{
    if(confirm('Clear ALL locally saved events?')){ localStorage.removeItem(LS); EVENTS=[]; EDIT_INDEX=-1; render(); }
  };

  document.getElementById('exportJson').onclick=()=>{
    const a=document.createElement('a');
    a.href=URL.createObjectURL(new Blob([JSON.stringify({events:EVENTS},null,2)], {type:'application/json'}));
    a.download='events.json'; a.click();
  };
  document.getElementById('exportIcs').onclick=()=>{
    const a=document.createElement('a');
    a.href=URL.createObjectURL(new Blob([toICS(EVENTS)], {type:'text/calendar'}));
    a.download='events.ics'; a.click();
  };

  /* ===== 5) Init ===== */
  render();

</script>
</body>
</html>
