<!-- calendar-backend-firebase-patched.html with logger -->
<html>
<head>
  <meta charset="UTF-8">
  <title>BASIC Calendar Admin</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    button { margin: 5px; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
</head>
<body>
  <h1>Calendar Backend Admin</h1>
  <button id="publish">Publish to Cloud</button>
  <button id="changeCode">Change Admin Code</button>

  <script>
    // Paste your firebaseConfig here
    const firebaseConfig = {
  apiKey: "AIzaSyBUWTNk3fhYSY6hAgiuaLcThzy_xp1EN-c",
  authDomain: "basic-calendar-6404a.firebaseapp.com",
  projectId: "basic-calendar-6404a",
  storageBucket: "basic-calendar-6404a.firebasestorage.app",
  messagingSenderId: "714238179784",
  appId: "1:714238179784:web:d26b77c0a4a6f7c8db68fd"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const COL = db.collection('basic_calendar');

    let EVENTS = [{title: "Test Event", start: Date.now()}]; // sample
    let ADMIN_CODE = '';

    function ensureAdminCode() {
      if (!ADMIN_CODE) {
        ADMIN_CODE = sessionStorage.getItem('BASIC_ADMIN_CODE') || prompt('Enter admin code:');
        if (ADMIN_CODE) sessionStorage.setItem('BASIC_ADMIN_CODE', ADMIN_CODE);
      }
      return !!ADMIN_CODE;
    }

    document.getElementById('changeCode').onclick = () => {
      sessionStorage.removeItem('BASIC_ADMIN_CODE');
      ADMIN_CODE = '';
      alert('Admin code cleared. Click “Publish to Cloud” and enter the new code.');
    };

    document.getElementById('publish').onclick = async () => {
      if (!EVENTS.length) { alert('No events to publish'); return; }
      if (!ensureAdminCode()) { alert('Admin code is required to publish.'); return; }

      const payload = { events: EVENTS, updated: Date.now(), adminCode: ADMIN_CODE };
      console.log('[Publish] sending', payload);

      try {
        await COL.doc('live').set(payload);
        console.log('[Publish] success');
        alert('Published! The public calendar will refresh automatically.');
      } catch (err) {
        console.error('[Publish] error', err);
        alert(`Publish failed: ${err.code || 'unknown'}\n${err.message || ''}`);
        if (err.code === 'permission-denied') {
          sessionStorage.removeItem('BASIC_ADMIN_CODE');
          ADMIN_CODE = '';
          alert('Admin code was rejected. Click “Publish to Cloud” and re-enter the correct code.');
        }
      }
    };
  </script>
</body>
</html>
