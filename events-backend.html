<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BASIC Calendar — Backend (Review & Publish • Draft/Featured • Import • Audit)</title>
<style>
  :root{
    --bg:#0b1324; --card:#121a31; --ink:#e8eefc; --muted:#9fb0d3;
    --accent:#6cc2ff; --ok:#47d17a; --warn:#ffb454; --danger:#ff6b6b;
    --line:#22325e; --soft:#0f1a33; --radius:14px; --shadow:0 12px 36px rgba(0,0,0,.30)
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b1324 0%,#0e1a34 100%);color:var(--ink);
       font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{position:sticky;top:0;z-index:5;background:rgba(11,19,36,.85);backdrop-filter:saturate(160%) blur(10px);
         border-bottom:1px solid #1e2a4a}
  .wrap{max-width:1100px;margin:auto;padding:18px}
  h1{margin:0 0 4px;font-weight:800}
  .subtitle{color:var(--muted)}
  .grid{display:grid;gap:16px}
  .two{grid-template-columns:1.15fr .85fr}
  @media (max-width:1024px){.two{grid-template-columns:1fr}}

  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
  .pad{padding:16px}
  label{display:block;font-weight:700;margin:10px 0 6px}
  input, select, textarea{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #2c3e6a;background:var(--soft);color:var(--ink)}
  textarea{min-height:100px}
  .split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .muted{color:var(--muted)}
  .note{font-size:13px;color:var(--muted);margin-top:8px}

  .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
  button{border:0;border-radius:999px;padding:10px 16px;font-weight:800;cursor:pointer}
  .primary{background:var(--accent);color:#051127}
  .ok{background:var(--ok);color:#062616}
  .warn{background:var(--warn);color:#3a2200}
  .danger{background:var(--danger);color:#2b0707}
  .ghost{background:var(--soft);color:var(--ink);border:1px solid #2c3e6a}

  .list{display:grid;gap:10px}
  .event-item{display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center;background:#101a34;border:1px solid #22325e;border-radius:12px;padding:10px}
  .event-item img{width:56px;height:56px;object-fit:cover;border-radius:10px}
  .pill{font-size:12px;background:#0f284d;color:#b9d4ff;border:1px solid #214a89;padding:2px 8px;border-radius:999px}
  .mini{font-size:12px;color:var(--muted)}
  .kpi{font-weight:800}

  details.more summary{cursor:pointer;user-select:none;margin:14px 0 0}
  details.more .row{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}

  /* Modal (review & publish + import) */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:20px;z-index:1000}
  .modal .win{max-width:820px;width:100%;background:#0f1630;color:var(--ink);border:1px solid #27345f;border-radius:16px;box-shadow:0 20px 50px rgba(0,0,0,.4);overflow:hidden}
  .modal header{display:flex;justify-content:space-between;align-items:center;background:#0f1a33;border-bottom:1px solid #22325e;padding:12px 16px}
  .modal .body{padding:16px;max-height:70vh;overflow:auto}
  .close{background:transparent;border:1px solid #2c3e6a;color:var(--ink);border-radius:999px;padding:6px 10px;cursor:pointer}
  .cols{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .bucket{border:1px dashed #2b3d6c;border-radius:12px;padding:10px}
  .bucket h4{margin:0 0 8px}
  .bucket li{font-size:14px;margin:0 0 6px}
  .right{display:flex;gap:10px;align-items:center}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>BASIC Calendar — Backend</h1>
    <div class="subtitle">Friendly editor. Save locally → <b>Review & Publish</b> (admin code required). Drafts stay hidden.</div>
  </div>
</header>

<div class="wrap grid two">
  <!-- LEFT: Form -->
  <section class="card pad">
    <h2>Event editor</h2>

    <label>Title *</label>
    <input id="title" placeholder="e.g., Community Movie Night" />

    <div class="split">
      <div>
        <label>Category</label>
        <input id="category" placeholder="Workshop, Fundraiser" />
      </div>
      <div>
        <label>Location</label>
        <input id="location" placeholder="Address or place name" />
      </div>
    </div>

    <div class="split">
      <label style="display:flex;align-items:center;gap:8px;margin-top:16px">
        <input type="checkbox" id="allDay" /> All-day
      </label>
      <div>
        <label>RSVP / Ticket URL</label>
        <input id="rsvp" placeholder="https://…" />
      </div>
    </div>

    <label>Description</label>
    <textarea id="description" placeholder="Line breaks are preserved on the website."></textarea>

    <div class="split" id="timeRow">
      <div>
        <label>Start date & time *</label>
        <input id="start" type="datetime-local" />
      </div>
      <div>
        <label>End date & time</label>
        <input id="end" type="datetime-local" />
      </div>
    </div>

    <div class="split">
      <div>
        <label>Image (URL)</label>
        <input id="image" placeholder="https://…/photo.jpg" />
      </div>
      <div>
        <label>Video (YouTube/Vimeo URL)</label>
        <input id="video" placeholder="https://youtu.be/… or https://vimeo.com/…" />
      </div>
    </div>

    <div class="split">
      <div>
        <label>Place URL (optional, from Google Maps)</label>
        <input id="placeUrl" placeholder="https://maps.app.goo.gl/…" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="ghost" id="mapsHelper" type="button">Open location in Google Maps</button>
      </div>
    </div>

    <label>Attachments (comma-separated — use “url|nice label” for custom text)</label>
    <input id="attachments" placeholder="https://site.com/flyer.pdf|Event flyer, https://…/agenda.docx" />

    <details class="more">
      <summary>Repeating (optional)</summary>
      <div class="split">
        <div>
          <label>Frequency</label>
          <select id="freq">
            <option value="none">Does not repeat</option>
            <option value="DAILY">Daily</option>
            <option value="WEEKLY">Weekly</option>
            <option value="MONTHLY">Monthly</option>
            <option value="YEARLY">Yearly</option>
          </select>
        </div>
        <div>
          <label>Every…</label>
          <input id="interval" type="number" value="1" min="1" />
        </div>
      </div>
      <div class="split">
        <div>
          <label>Days (WEEKLY) – MO,TU,WE,TH,FR,SA,SU</label>
          <input id="byday" placeholder="WE,FR" />
        </div>
        <div>
          <label>Until (end date)</label>
          <input id="until" type="date" />
        </div>
      </div>
      <div class="split">
        <label style="display:flex;align-items:center;gap:8px;margin-top:6px">
          <input type="checkbox" id="draft" /> Draft (hide on public site)
        </label>
        <label style="display:flex;align-items:center;gap:8px;margin-top:6px">
          <input type="checkbox" id="featured" /> Featured (highlight)
        </label>
      </div>
      <div class="note">Uses a simple iCalendar RRULE.</div>
    </details>

    <!-- Primary actions -->
    <div class="actions">
      <button class="primary" id="saveLocal" type="button">Save (Local)</button>
      <button class="ok" id="loadCloud" type="button">Load from Cloud</button>
      <button class="ok" id="reviewPublish" type="button">Review & Publish</button>
      <button class="danger" id="wipeCloud" type="button">Delete from Cloud</button>
    </div>

    <!-- Secondary -->
    <div class="actions">
      <button class="ghost" id="newEvent" type="button">New Event</button>
      <button class="ghost" id="changeCode" type="button">Change Admin Code</button>
      <button class="warn" id="clearAll" type="button">Clear Local</button>
      <button class="ghost" id="importBtn" type="button">Import CSV/ICS</button>
    </div>

    <details class="more">
      <summary>More (exports)</summary>
      <div class="row">
        <button class="ghost" id="exportJson" type="button">Export JSON</button>
        <button class="ghost" id="exportIcs" type="button">Export ICS</button>
      </div>
    </details>

    <div class="note">
      Local items: <span class="kpi" id="count">0</span> •
      Mode: <span class="kpi" id="modeLabel">New</span>
    </div>
  </section>

  <!-- RIGHT: Local list -->
  <section class="card pad">
    <h2>Local events</h2>
    <div id="list" class="list"></div>
    <div class="note">To remove something from public: <b>Load from Cloud → delete locally → Review & Publish</b>.</div>
  </section>
</div>

<!-- Review & Publish Modal -->
<div class="modal" id="reviewModal" aria-hidden="true">
  <div class="win">
    <header>
      <strong>Review changes</strong>
      <div class="right">
        <span id="reviewSummary" class="muted"></span>
        <button class="close" id="closeReview" type="button">Close</button>
      </div>
    </header>
    <div class="body">
      <div class="cols">
        <div class="bucket">
          <h4>Added</h4>
          <ul id="addedList"></ul>
        </div>
        <div class="bucket">
          <h4>Edited</h4>
          <ul id="changedList"></ul>
        </div>
        <div class="bucket">
          <h4>Deleted</h4>
          <ul id="removedList"></ul>
        </div>
      </div>
      <div class="actions" style="margin-top:14px">
        <input id="publisherName" placeholder="Your name/initials for audit log" style="flex:1;padding:10px 12px;border-radius:10px;border:1px solid #2c3e6a;background:#0f1a33;color:#e8eefc">
        <button class="ok" id="confirmPublish" type="button">Confirm Publish</button>
      </div>
      <div class="note">We’ll write an audit entry with counts and your name.</div>
    </div>
  </div>
</div>

<!-- Import Modal -->
<div class="modal" id="importModal" aria-hidden="true">
  <div class="win">
    <header>
      <strong>Import CSV / ICS</strong>
      <button class="close" id="closeImport" type="button">Close</button>
    </header>
    <div class="body">
      <p class="muted">CSV headers supported: title,description,start,end,allDay,category,location,rsvp,image,video,attachments,rrule,placeUrl,draft,featured</p>
      <div class="actions">
        <input type="file" id="fileInput" accept=".csv,.ics,text/calendar" />
        <button class="ok" id="importFile" type="button">Import File</button>
      </div>
      <p style="margin-top:10px">Or paste CSV rows:</p>
      <textarea id="csvPaste" placeholder="title,description,start,end,allDay,category,location,…" style="width:100%;min-height:120px"></textarea>
      <div class="actions">
        <button class="ok" id="importCsvText" type="button">Import CSV Text</button>
      </div>
    </div>
  </div>
</div>

<!-- Firebase v10 CDN -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script>
  /* ===== Firebase config ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyBUWTNk3fhYSY6hAgiuaLcThzy_xp1EN-c",
    authDomain: "basic-calendar-6404a.firebaseapp.com",
    projectId: "basic-calendar-6404a",
    storageBucket: "basic-calendar-6404a.firebasestorage.app",
    messagingSenderId: "714238179784",
    appId: "1:714238179784:web:d26b77c0a4a6f7c8db68fd"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const COL = db.collection('basic_calendar');
  const LOGS = db.collection('basic_calendar_logs'); // audit

  /* ===== Admin code (runtime only) ===== */
  let ADMIN_CODE = sessionStorage.getItem('BASIC_ADMIN_CODE') || '';
  function ensureAdminCode(force=false){
    if(force){ sessionStorage.removeItem('BASIC_ADMIN_CODE'); ADMIN_CODE=''; }
    if(!ADMIN_CODE){
      const input = prompt('Enter Admin Code to enable cloud changes:') || '';
      ADMIN_CODE = input.trim();
      if(ADMIN_CODE) sessionStorage.setItem('BASIC_ADMIN_CODE', ADMIN_CODE);
    }
    return !!ADMIN_CODE;
  }

  /* ===== State & helpers ===== */
  const $=s=>document.querySelector(s);
  const LS='basic_events_v4';
  const load=()=>{try{return JSON.parse(localStorage.getItem(LS))||[]}catch{return []}};
  const save=v=>{localStorage.setItem(LS,JSON.stringify(v)); updateCount();}
  let EVENTS = load();
  let EDIT_INDEX = -1; // -1 = New mode
  updateModeLabel();

  function updateCount(){ $('#count').textContent = (EVENTS||[]).length; }
  function updateModeLabel(){ $('#modeLabel').textContent = EDIT_INDEX>-1 ? 'Editing' : 'New'; }

  function rrule(){
    const f=$('#freq').value; if(f==='none') return '';
    const parts=[`FREQ=${f}`];
    const i=parseInt($('#interval').value||'1',10); if(i>1) parts.push(`INTERVAL=${i}`);
    const d=$('#byday').value.replace(/\s+/g,''); if(d) parts.push(`BYDAY=${d}`);
    const u=$('#until').value; if(u) parts.push(`UNTIL=${u.replace(/-/g,'')}T235959Z`);
    return parts.join(';');
  }

  function normalizeAllDay(startVal){
    const d=new Date(startVal||Date.now());
    const y=d.getFullYear(), m=('0'+(d.getMonth()+1)).slice(-2), da=('0'+d.getDate()).slice(-2);
    return [`${y}-${m}-${da}T00:00`, `${y}-${m}-${da}T23:59`];
  }

  function nowIso(){ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,16); }

  function getForm(){
    const allDay = $('#allDay').checked;
    const startVal = $('#start').value;
    let endVal = $('#end').value || startVal || '';
    let [s,e] = [startVal, endVal];
    if(allDay){ [s,e] = normalizeAllDay(startVal); }
    const baseId = (EDIT_INDEX>-1 && EVENTS[EDIT_INDEX])? EVENTS[EDIT_INDEX].id : ($('#title').dataset.id || ('ev_'+Date.now()));

    return {
      id: baseId,
      title: $('#title').value.trim(),
      category: $('#category').value.trim(),
      description: $('#description').value,
      start: s, end: e,
      allDay: !!allDay,
      location: $('#location').value.trim(),
      rsvp: $('#rsvp').value.trim(),
      image: $('#image').value.trim(),
      video: $('#video').value.trim(),
      attachments: $('#attachments').value.split(',').map(s=>s.trim()).filter(Boolean),
      rrule: rrule(),
      placeUrl: $('#placeUrl').value.trim(),
      draft: $('#draft').checked,
      featured: $('#featured').checked
    };
  }

  function setForm(e={}){
    const f=(id,val)=>{ const el=document.getElementById(id); if(el) el.value = val||''; };
    f('title', e.title); f('category', e.category); f('description', e.description);
    f('start', e.start); f('end', e.end); f('location', e.location);
    f('rsvp', e.rsvp); f('image', e.image); f('video', e.video);
    f('placeUrl', e.placeUrl);
    document.getElementById('attachments').value = (e.attachments||[]).join(', ');
    // flags
    document.getElementById('draft').checked = !!e.draft;
    document.getElementById('featured').checked = !!e.featured;

    // repeats
    document.getElementById('freq').value = (e.rrule? (e.rrule.match(/FREQ=([A-Z]+)/)||[])[1] : 'none') || 'none';
    document.getElementById('interval').value = (e.rrule? (e.rrule.match(/INTERVAL=(\d+)/)||[])[1] : 1) || 1;
    document.getElementById('byday').value = (e.rrule? (e.rrule.match(/BYDAY=([A-Z,]+)/)||[])[1] : '') || '';
    const until = (e.rrule? (e.rrule.match(/UNTIL=(\d{8})/)||[])[1] : '') || '';
    document.getElementById('until').value = until? `${until.slice(0,4)}-${until.slice(4,6)}-${until.slice(6,8)}` : '';

    // All-day display hint
    document.getElementById('allDay').checked = !!e.allDay;
    toggleAllDay(!!e.allDay);

    // remember last edited id on the title field (to prevent dupes)
    document.getElementById('title').dataset.id = e.id || '';
  }

  function toggleAllDay(checked){
    const row = document.getElementById('timeRow');
    row.style.opacity = checked ? .6 : 1;
  }

  function render(){
    updateCount(); updateModeLabel();
    const box=$('#list'); box.innerHTML='';
    EVENTS
      .slice()
      .sort((a,b)=>new Date(a.start)-new Date(b.start))
      .forEach((e,i)=>{
        const row=document.createElement('div'); row.className='event-item';
        row.innerHTML=`
          <img src="${e.image||('https://picsum.photos/seed/'+encodeURIComponent(e.title||'event')+'/120/120')}" alt="">
          <div>
            <div><strong>${e.title||'Untitled'}</strong> <span class="pill">${e.category||'General'}</span> ${e.draft?'<span class="pill" style="background:#3a2d0b;border-color:#7b641e;color:#ffe8a3">Draft</span>':''} ${e.featured?'<span class="pill" style="background:#113a2b;border-color:#1f6349;color:#91ffd0">Featured</span>':''}</div>
            <div class="mini">${formatRange(e)}</div>
            <div class="mini">${e.location||''}</div>
          </div>
        `;
        const btns=document.createElement('div'); btns.style.display='flex'; btns.style.gap='8px';

        const edit=document.createElement('button'); edit.className='ghost'; edit.textContent='Edit';
        edit.onclick=()=>{ EDIT_INDEX=i; setForm(e); window.scrollTo({top:0, behavior:'smooth'}); };

        const dup=document.createElement('button'); dup.className='ghost'; dup.textContent='Duplicate';
        dup.onclick=()=>{ const c={...e,id:'ev_'+Date.now()}; EVENTS.push(c); save(EVENTS); render(); };

        const del=document.createElement('button'); del.className='danger'; del.textContent='Delete';
        del.onclick=()=>{ if(confirm(`Delete “${e.title||'event'}” locally?`)){ EVENTS.splice(i,1); save(EVENTS); render(); } };

        btns.append(edit, dup, del); row.appendChild(btns); box.appendChild(row);
      });
  }

  function formatRange(e){
    const A=new Date(e.start), B=new Date(e.end||e.start);
    if(e.allDay){
      return `${A.toLocaleDateString([], {weekday:'short', month:'short', day:'numeric'})} (all-day)`;
    }
    const same = A.toDateString()===B.toDateString();
    return same
      ? `${A.toLocaleDateString([], {weekday:'short', month:'short', day:'numeric'})} • ${A.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'})}–${B.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'})}`
      : `${A.toLocaleString([], {dateStyle:'medium', timeStyle:'short'})} – ${B.toLocaleString([], {dateStyle:'medium', timeStyle:'short'})}`;
  }

  /* ===== ICS export ===== */
  function escapeICS(s){return String(s||'').replace(/[\\;,\n]/g, m => ({"\\":"\\\\",";":"\\;",",":"\\,","\n":"\\n"}[m]));}
  function toICS(list){
    const lines=[`BEGIN:VCALENDAR`,`VERSION:2.0`,`PRODID:-//BASIC//Calendar//EN`];
    list.forEach(ev=>{
      lines.push('BEGIN:VEVENT');
      lines.push('UID:'+ev.id);
      lines.push('SUMMARY:'+escapeICS(ev.title||''));
      if(ev.description) lines.push('DESCRIPTION:'+escapeICS(ev.description));
      if(ev.location) lines.push('LOCATION:'+escapeICS(ev.location));
      if(ev.allDay){
        const s=new Date(ev.start); const pad=n=>String(n).padStart(2,'0');
        const d2=(d)=>`${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}`;
        const e=new Date(s); e.setDate(e.getDate()+1);
        lines.push(`DTSTART;VALUE=DATE:${d2(s)}`);
        lines.push(`DTEND;VALUE=DATE:${d2(e)}`);
      }else{
        if(ev.start) lines.push('DTSTART:'+new Date(ev.start).toISOString().replace(/[-:]/g,'').split('.')[0]+'Z');
        if(ev.end)   lines.push('DTEND:'+new Date(ev.end).toISOString().replace(/[-:]/g,'').split('.')[0]+'Z');
      }
      if(ev.rrule) lines.push('RRULE:'+ev.rrule);
      lines.push('END:VEVENT');
    });
    lines.push('END:VCALENDAR');
    return lines.join('\n');
  }

  /* ===== Diff + Review & Publish ===== */
  function indexById(list){ const m=new Map(); (list||[]).forEach(e=>m.set(e.id, e)); return m; }
  function shallowEqual(a,b){
    const keys = new Set([...Object.keys(a||{}), ...Object.keys(b||{})]);
    ['updated'].forEach(k=>keys.delete(k));
    let same=true;
    keys.forEach(k=>{ if(JSON.stringify(a[k]) !== JSON.stringify(b[k])) same=false; });
    return same;
  }

  async function reviewPublishFlow(){
    if(!ensureAdminCode()) return;
    const snap = await COL.doc('live').get();
    const cloud = snap.exists ? (snap.data().events||[]) : [];
    const A=indexById(EVENTS), B=indexById(cloud);
    const added=[], changed=[], removed=[];
    A.forEach((v,id)=>{ if(!B.has(id)) added.push(v); else if(!shallowEqual(v, B.get(id))) changed.push(v); });
    B.forEach((v,id)=>{ if(!A.has(id)) removed.push(v); });

    $('#addedList').innerHTML = added.map(x=>`<li>${escapeHtml(x.title||'Untitled')} — ${new Date(x.start).toLocaleString()}</li>`).join('') || '<li class="muted">None</li>';
    $('#changedList').innerHTML = changed.map(x=>`<li>${escapeHtml(x.title||'Untitled')} — ${new Date(x.start).toLocaleString()}</li>`).join('') || '<li class="muted">None</li>';
    $('#removedList').innerHTML = removed.map(x=>`<li>${escapeHtml(x.title||'Untitled')} — ${new Date(x.start).toLocaleString()}</li>`).join('') || '<li class="muted">None</li>';
    $('#reviewSummary').textContent = `Added ${added.length} • Edited ${changed.length} • Deleted ${removed.length} • Total ${EVENTS.length}`;

    openModal('reviewModal');

    $('#confirmPublish').onclick = async ()=>{
      const actor = ($('#publisherName').value||'').trim() || 'Unknown';
      try{
        const payload = { events: EVENTS, updated: Date.now(), adminCode: ADMIN_CODE };
        await COL.doc('live').set(payload);
        await LOGS.add({ ts: Date.now(), actor, counts: { added: added.length, changed: changed.length, removed: removed.length, total: EVENTS.length } });
        closeModal('reviewModal');
        alert('Published! Public calendar will update automatically.');
      }catch(err){
        console.error('[Publish] error', err);
        alert(`Publish failed: ${err.code||'unknown'}\n${err.message||''}`);
        if(err.code==='permission-denied'){ ensureAdminCode(true); }
      }
    };
  }

  function openModal(id){ const m=document.getElementById(id); if(m){ m.style.display='flex'; m.setAttribute('aria-hidden','false'); } }
  function closeModal(id){ const m=document.getElementById(id); if(m){ m.style.display='none'; m.setAttribute('aria-hidden','true'); } }

  /* ===== Import (CSV/ICS) ===== */
  function parseCSV(text){
    const lines=(text||'').trim().split(/\r?\n/).filter(Boolean);
    if(!lines.length) return [];
    const headers = lines[0].split(',').map(h=>h.trim().toLowerCase());
    const rows = lines.slice(1).map(l=> l.split(',').map(c=>c.trim()));
    const items=[];
    rows.forEach(cols=>{
      const obj={};
      headers.forEach((h,i)=> obj[h]=cols[i]||'');
      const allDay = /^(1|true|yes)$/i.test(obj.allday||obj.all_day||'');
      let start=obj.start||'', end=obj.end||start;
      if(allDay && start){ [start,end] = normalizeAllDay(start); }
      items.push({
        id: obj.id || '',
        title: obj.title || '',
        description: obj.description || '',
        category: obj.category || '',
        location: obj.location || '',
        rsvp: obj.rsvp || '',
        image: obj.image || '',
        video: obj.video || '',
        attachments: (obj.attachments||'').split(/[;,]/).map(s=>s.trim()).filter(Boolean),
        start, end, allDay,
        rrule: obj.rrule || '',
        placeUrl: obj.placeurl || obj.place_url || '',
        draft: /^(1|true|yes)$/i.test(obj.draft||''),
        featured: /^(1|true|yes)$/i.test(obj.featured||'')
      });
    });
    return items;
  }

  function parseICS(text){
    const items=[]; const lines=(text||'').split(/\r?\n/);
    let cur=null;
    function dt(v){
      if(!v) return '';
      if(v.includes('T')){ const y=v.slice(0,4),m=v.slice(4,6),d=v.slice(6,8),hh=v.slice(9,11)||'00',mm=v.slice(11,13)||'00'; return `${y}-${m}-${d}T${hh}:${mm}`; }
      const y=v.slice(0,4),m=v.slice(4,6),d=v.slice(6,8); return `${y}-${m}-${d}T00:00`;
    }
    lines.forEach(raw=>{
      const line = raw.trim();
      if(line==='BEGIN:VEVENT'){ cur={}; }
      else if(line==='END:VEVENT'){ if(cur){
        const allDay = cur.DTSTART && !cur.DTSTART.includes('T');
        let start = dt(cur.DTSTART||''); let end = dt(cur.DTEND||cur.DTSTART||'');
        if(allDay && start){ const [s,e]=normalizeAllDay(start); start=s; end=e; }
        items.push({
          id: cur.UID || ('ev_'+Date.now()+Math.floor(Math.random()*1000)),
          title: cur.SUMMARY || '',
          description: cur.DESCRIPTION || '',
          category: cur.CATEGORIES || '',
          location: cur.LOCATION || '',
          rsvp: '',
          image: '',
          video: '',
          attachments: [],
          start, end, allDay,
          rrule: cur.RRULE || '',
          placeUrl: '',
          draft:false, featured:false
        }); cur=null; }
      }
      else if(cur){
        const [k,v] = line.split(/:(.+)/);
        const key = (k||'').split(';')[0];
        cur[key] = (cur[key]? cur[key]+'\n' : '') + (v||'');
      }
    });
    return items;
  }

  /* ===== Button wiring (after DOM is ready) ===== */
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('mapsHelper').addEventListener('click', ()=>{
      const q = ($('#location').value||'').trim();
      if(!q){ alert('Enter a location first.'); return; }
      const url = 'https://www.google.com/maps/search/?api=1&query='+encodeURIComponent(q);
      window.open(url,'_blank','noopener');
    });

    document.getElementById('newEvent').addEventListener('click', ()=>{
      EDIT_INDEX=-1; updateModeLabel();
      const newId = 'ev_'+Date.now();
      $('#title').dataset.id = newId;
      setForm({ id:newId, start: nowIso(), end: nowIso() });
    });

    document.getElementById('saveLocal').addEventListener('click', ()=>{
      const ev=getForm();
      if(!ev.title || !ev.start){ alert('Title and Start are required.'); return; }
      if(!ev.end){ ev.end = ev.start; }

      const existingIndex = EVENTS.findIndex(x=>x.id===ev.id);
      if(EDIT_INDEX>-1){
        EVENTS[EDIT_INDEX]=ev; EDIT_INDEX=-1; updateModeLabel();
      }else if(existingIndex>-1){
        EVENTS[existingIndex]=ev;
      }else{
        EVENTS.push(ev);
      }
      save(EVENTS); render();
    });

    document.getElementById('loadCloud').addEventListener('click', async ()=>{
      try{
        const doc=await COL.doc('live').get();
        const data=doc.exists ? (doc.data()||{}) : {};
        const list=data.events||[];
        if(!list.length){ if(confirm('No events in cloud. Replace your local list with empty?')){ EVENTS=[]; save(EVENTS); render(); } return; }
        if(confirm(`Load ${list.length} event(s) from cloud and replace your local list?`)){
          EVENTS = list;
          save(EVENTS); render();
        }
      }catch(err){
        console.error('[Load] error', err);
        alert(`Load failed: ${err.code||'unknown'}\n${err.message||''}`);
      }
    });

    // FIXED: no stray parenthesis
    document.getElementById('reviewPublish').onclick = reviewPublishFlow;

    document.getElementById('wipeCloud').addEventListener('click', async ()=>{
      if(!confirm('Delete ALL events from the public calendar? This can be undone by publishing again.')) return;
      if(!ensureAdminCode()) return;
      const actor = prompt('Your name/initials for audit log?') || 'Unknown';
      const payload={ events: [], updated: Date.now(), adminCode: ADMIN_CODE };
      try{
        await COL.doc('live').set(payload);
        await LOGS.add({ ts: Date.now(), actor, counts: {added:0,changed:0,removed:'ALL',total:0}, action:'wipe' });
        alert('Cloud list cleared.');
      }catch(err){
        console.error('[Delete cloud] error', err);
        alert(`Delete failed: ${err.code||'unknown'}\n${err.message||''}`);
        if(err.code==='permission-denied'){ ensureAdminCode(true); }
      }
    });

    document.getElementById('changeCode').addEventListener('click', ()=>{ ensureAdminCode(true); alert('Admin code cleared. Use a cloud action to enter the new one.'); });

    document.getElementById('clearAll').addEventListener('click', ()=>{
      if(confirm('Clear ALL locally saved events?')){ localStorage.removeItem(LS); EVENTS=[]; EDIT_INDEX=-1; updateModeLabel(); render(); }
    });

    document.getElementById('exportJson').addEventListener('click', ()=>{
      const a=document.createElement('a');
      a.href=URL.createObjectURL(new Blob([JSON.stringify({events:EVENTS},null,2)], {type:'application/json'}));
      a.download='events.json'; a.click();
    });

    document.getElementById('exportIcs').addEventListener('click', ()=>{
      const a=document.createElement('a');
      a.href=URL.createObjectURL(new Blob([toICS(EVENTS)], {type:'text/calendar'}));
      a.download='events.ics'; a.click();
    });

    document.getElementById('closeReview').addEventListener('click', ()=>closeModal('reviewModal'));

    document.getElementById('importBtn').addEventListener('click', ()=>openModal('importModal'));
    document.getElementById('closeImport').addEventListener('click', ()=>closeModal('importModal'));
    document.getElementById('importFile').addEventListener('click', async ()=>{
      const f=document.getElementById('fileInput').files[0];
      if(!f){ alert('Choose a CSV or ICS file'); return; }
      const text = await f.text();
      const newItems = f.name.toLowerCase().endsWith('.ics') ? parseICS(text) : parseCSV(text);
      if(!newItems.length){ alert('No items parsed.'); return; }
      if(confirm(`Import ${newItems.length} item(s) into local list?`)){
        newItems.forEach(ev=>{
          if(!ev.id) ev.id = 'ev_'+Date.now()+Math.floor(Math.random()*1000);
          const idx = EVENTS.findIndex(x=>x.id===ev.id);
          if(idx>-1) EVENTS[idx]=ev; else EVENTS.push(ev);
        });
        save(EVENTS); render(); closeModal('importModal');
      }
    });
    document.getElementById('importCsvText').addEventListener('click', ()=>{
      const text = document.getElementById('csvPaste').value||'';
      const items = parseCSV(text);
      if(!items.length){ alert('Nothing to import'); return; }
      if(confirm(`Import ${items.length} item(s) into local list?`)){
        items.forEach(ev=>{
          if(!ev.id) ev.id = 'ev_'+Date.now()+Math.floor(Math.random()*1000);
          const idx = EVENTS.findIndex(x=>x.id===ev.id);
          if(idx>-1) EVENTS[idx]=ev; else EVENTS.push(ev);
        });
        save(EVENTS); render(); closeModal('importModal');
      }
    });

    // initial render + wiring minor toggles
    document.getElementById('allDay').addEventListener('change', (e)=>toggleAllDay(e.target.checked));
    render();
  });

  /* ===== Misc helpers ===== */
  function openModal(id){ const m=document.getElementById(id); if(m){ m.style.display='flex'; m.setAttribute('aria-hidden','false'); } }
  function closeModal(id){ const m=document.getElementById(id); if(m){ m.style.display='none'; m.setAttribute('aria-hidden','true'); } }
  function escapeHtml(s){return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
</script>
</body>
</html>
