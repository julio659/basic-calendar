<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BASIC Calendar – Pinboard (Date Pivot)</title>
<style>
  :root{
    --ink:#0f172a; --muted:#475569; --card:#ffffff; --line:#e6ecf5; --chip:#f7faff;
    --blue1:#e0f2ff; --blue2:#93c5fd; --blue3:#60a5fa; --blue4:#3b82f6;
    --shadow:0 10px 30px rgba(2,8,23,.08);
  }
  *{box-sizing:border-box}
  body{margin:0;background:transparent;color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  a{color:var(--blue4)}
  .wrap{max-width:1100px;margin:auto;padding:16px;background:transparent}

  header{position:sticky;top:0;z-index:5;background:rgba(255,255,255,.78);backdrop-filter:saturate(160%) blur(8px);border-bottom:1px solid rgba(230,236,245,.9)}
  h1{margin:0 0 6px;font-weight:800;letter-spacing:.2px}

  .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  select,input{appearance:none;background:#fff;border:1px solid var(--line);color:var(--ink);border-radius:12px;padding:10px 12px;box-shadow:0 1px 0 rgba(0,0,0,.02)}
  select:focus,input:focus{outline:none;border-color:var(--blue3);box-shadow:0 0 0 3px rgba(96,165,250,.25)}
  .status{font-size:12px;color:var(--muted);margin-top:6px}

  .datebar{display:flex;align-items:center;gap:8px}
  .btn{
    border:1px solid var(--line);background:linear-gradient(90deg,#ffffff,#eef6ff);
    color:#0b1220;border-radius:999px;padding:8px 12px;font-weight:800;cursor:pointer;
    box-shadow:0 6px 12px rgba(15,23,42,.06);transition:transform .08s ease, box-shadow .2s ease
  }
  .btn:hover{box-shadow:0 10px 18px rgba(15,23,42,.10)}
  .btn:active{transform:translateY(1px)}
  .btn.icon{padding:6px 10px}

  .pinboard{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px;background:transparent}
  .group{grid-column:1/-1;margin:8px 0 0;color:#0b1220;font-weight:900}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;overflow:hidden;box-shadow:var(--shadow)}
  .card img{width:100%;height:150px;object-fit:cover}
  .card .pad{padding:12px}
  .pill{font-size:12px;background:linear-gradient(90deg,#e0f2ff,#bfdbfe);color:#0a1220;border:0;padding:4px 10px;border-radius:999px;font-weight:800}
  .mini{color:var(--muted);font-size:13px}
  .no-results{padding:24px;border:1px dashed var(--line);border-radius:12px;text-align:center;color:var(--muted);background:#fff}

  /* Clamp long preview descriptions */
  .clamp{
    position:relative;
    display:-webkit-box; -webkit-line-clamp:6; -webkit-box-orient:vertical;
    overflow:hidden; min-height:0;
  }
  .clamp::after{
    content:""; position:absolute; inset:auto 0 0 0; height:2.4em;
    background:linear-gradient(180deg, rgba(255,255,255,0), rgba(255,255,255,1));
  }

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(2,8,23,.6);display:none;align-items:flex-start;justify-content:center;padding:64px 20px;z-index:1000}
  .modal .window{
    max-width:760px;width:100%;background:#fff;color:var(--ink);
    border:1px solid var(--line);border-radius:18px;box-shadow:0 20px 50px rgba(0,0,0,.25);
    max-height:calc(100vh - 128px); display:flex; flex-direction:column; overflow:hidden;
  }
  .window header{background:linear-gradient(180deg,#ffffff,#f8fbff);border-bottom:1px solid var(--line);z-index:1;padding:12px 16px}
  .window .content{padding:16px; overflow:auto}
  .close{float:right;background:transparent;border:0;color:var(--ink);font-size:28px;cursor:pointer}

  /* Action bar (icon buttons) */
  .actionbar{
    display:flex; align-items:center; flex-wrap:wrap; gap:10px;
    padding:10px 16px; border-bottom:1px solid var(--line); background:#fff;
    position:sticky; top:0; z-index:2;
  }
  .iconbtn{
    display:inline-flex; align-items:center; gap:8px; cursor:pointer;
    border:1px solid var(--line); background:linear-gradient(90deg,#ffffff,#eef6ff);
    padding:8px 14px; border-radius:999px; font-weight:800; color:#0b1220;
    box-shadow:0 6px 12px rgba(15,23,42,.06); line-height:1;
  }
  .iconbtn svg{width:18px;height:18px;flex:0 0 18px}
  .iconbtn:hover{box-shadow:0 10px 18px rgba(15,23,42,.10)}
  .spacer{flex:1}
  .bar-group{display:flex; gap:10px; align-items:center}

  /* Calendar chooser */
  .cal-pop{
    position:fixed; z-index:2000; background:#fff; border:1px solid var(--line); border-radius:12px;
    box-shadow:0 18px 36px rgba(2,8,23,.18); padding:12px; display:none; min-width:300px;
  }
  .cal-pop.open{display:block}
  .cal-pop .row{display:flex; flex-wrap:wrap; gap:8px}
  .cal-pop a{border:1px solid var(--line); border-radius:10px; padding:8px 10px; text-decoration:none; color:#0b1220; background:#fff}
  .cal-pop a:hover{background:#f3f7ff}

  /* Toast (subtle) */
  .toast{
    position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px);
    background:rgba(255,255,255,.95); color:#0b1220; border:1px solid var(--line);
    padding:10px 14px; border-radius:999px; box-shadow:0 10px 22px rgba(2,8,23,.14);
    opacity:0; pointer-events:none; transition:opacity .18s ease, transform .18s ease; z-index:2500;
    font-weight:800; font-size:14px;
  }
  .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}
  .toast a{color:var(--blue4); text-decoration:none; font-weight:700; margin-left:8px}

  /* Respect newlines in the modal description */
  .desc { white-space: pre-wrap; }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Events calendar</h1>
    <div class="controls">
      <div class="datebar" aria-label="Choose start date">
        <button class="btn icon" id="prevMonth" title="Previous month">◀</button>
        <input type="date" id="pivot" />
        <button class="btn icon" id="nextMonth" title="Next month">▶</button>
        <button class="btn" id="todayBtn" title="Jump to today">Today</button>
      </div>
      <div style="flex:1"></div>
      <select id="filter" aria-label="Filter by category"><option value="">All categories</option></select>
      <input id="search" placeholder="Search (events, description)…" aria-label="Search events"/>
    </div>
    <div class="status" id="status">Connecting…</div>
  </div>
</header>

<div class="wrap" id="content" aria-live="polite"></div>

<!-- Toast -->
<div class="toast" id="toast">Link copied</div>
<!-- Calendar chooser popover -->
<div class="cal-pop" id="calPop">
  <div style="font-weight:800;margin-bottom:8px">Save to your calendar</div>
  <div class="row" id="calLinks"></div>
</div>

<!-- Modal -->
<div class="modal" id="modal" aria-modal="true" role="dialog" aria-labelledby="mTitle">
  <div class="window">
    <header>
      <button class="close" id="close" aria-label="Close">×</button>
      <h3 id="mTitle" style="margin:0"></h3>
      <div class="mini" id="mWhen"></div>
    </header>

    <!-- Action bar -->
    <div class="actionbar" id="actionbar">
      <div class="bar-group">
        <button class="iconbtn" id="shareX" title="Share on X" aria-label="Share on X">
          <!-- 𝕏 logo -->
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.9 2H22l-7.03 8.02L23 22h-6.9l-5.4-7.07L4.5 22H2l7.53-8.58L1 2h6.9l5 6.6L18.9 2Zm-1.2 18h1.9L8.4 4H6.5l11.2 16Z"/></svg>
          
        </button>
        <button class="iconbtn" id="shareFb" title="Share on Facebook" aria-label="Share on Facebook">
          <svg viewBox="0 0 24 24" fill="#1877F2"><path d="M22 12.07C22 6.48 17.52 2 11.93 2S2 6.48 2 12.07c0 5.01 3.66 9.16 8.44 9.93v-7.02H7.9v-2.91h2.54V9.41c0-2.5 1.49-3.88 3.77-3.88 1.09 0 2.23.2 2.23.2v2.46h-1.26c-1.24 0-1.63.77-1.63 1.56v1.88h2.78l-.44 2.91h-2.34V22c4.78-.77 8.44-4.92 8.44-9.93z"/></svg>
      
        </button>
        <button class="iconbtn" id="shareLi" title="Share on LinkedIn" aria-label="Share on LinkedIn">
          <svg viewBox="0 0 24 24" fill="#0A66C2"><path d="M4.98 3.5C4.98 4.88 3.86 6 2.5 6S0 4.88 0 3.5 1.12 1 2.5 1s2.48 1.12 2.48 2.5zM.5 8h4V23h-4V8zm7 0h3.8v2.05h.05c.53-1 1.85-2.05 3.8-2.05 4.07 0 4.82 2.68 4.82 6.17V23h-4v-6.71c0-1.6-.03-3.66-2.23-3.66-2.24 0-2.58 1.74-2.58 3.54V23h-3.86V8z"/></svg>
          
        </button>
      </div>

      <div class="spacer"></div>

      <div class="bar-group">
        <button class="iconbtn" id="saveCal" title="Save to calendar" aria-label="Save to calendar">
          <svg viewBox="0 0 24 24" fill="none"><rect x="3" y="4" width="18" height="17" rx="2" stroke="#0f172a" stroke-width="2"/><path d="M16 2v4M8 2v4M3 10h18" stroke="#0f172a" stroke-width="2"/></svg>
          Save
        </button>
        <button class="iconbtn" id="copyLink" title="Copy event link" aria-label="Copy event link">
          <svg viewBox="0 0 24 24" fill="none"><path d="M8 12a4 4 0 014-4h3a4 4 0 010 8h-3" stroke="#0f172a" stroke-width="2"/><path d="M16 12a4 4 0 01-4 4H9a4 4 0 110-8h3" stroke="#0f172a" stroke-width="2"/></svg>
          Copy link
        </button>
        <button class="iconbtn" id="emailBtn" title="Email event" aria-label="Email event">
          <svg viewBox="0 0 24 24" fill="none"><rect x="3" y="5" width="18" height="14" rx="2" stroke="#0f172a" stroke-width="2"/><path d="M3 7l9 7 9-7" stroke="#0f172a" stroke-width="2"/></svg>
          Email
        </button>
      </div>
    </div>

    <div class="content" id="modalContent" tabindex="0">
      <img id="mImg" alt="" style="width:100%;max-height:260px;object-fit:cover;display:none;border-radius:12px">
      <p id="mDesc" class="desc" style="margin-top:12px"></p>
      <div class="mini" id="mWhere"></div>
      <div id="mVideo" style="margin-top:12px"></div>
      <div style="margin-top:14px"><a class="btn primary" id="mRsvp" target="_blank" rel="noopener" style="display:none">RSVP / Tickets</a></div>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>
<script>
  /* ---------------- Firebase init ---------------- */
  const firebaseConfig = {
    apiKey: "AIzaSyBUWTNk3fhYSY6hAgiuaLcThzy_xp1EN-c",
    authDomain: "basic-calendar-6404a.firebaseapp.com",
    projectId: "basic-calendar-6404a",
    storageBucket: "basic-calendar-6404a.firebasestorage.app",
    messagingSenderId: "714238179784",
    appId: "1:714238179784:web:d26b77c0a4a6f7c8db68fd"
  };
  firebase.initializeApp(firebaseConfig);
  const db=firebase.firestore();

  function subscribeEvents(cb){
    const statusBar = document.getElementById('status');
    return db.collection('basic_calendar').doc('live').onSnapshot(
      snap => {
        const data = snap.exists ? snap.data() : { events: [], updated: null };
        cb(data.events || [], data.updated || null);
        const when = data.updated ? new Date(data.updated).toLocaleString([], {dateStyle:'medium', timeStyle:'short'}) : '–';
        statusBar.textContent = `Live connection ✓  Calendar last updated: ${when}`;
      },
      err => {
        console.error('Firestore listener error:', err);
        statusBar.textContent = err?.code === 'permission-denied'
          ? 'Connection error: Firestore rules block reads on basic_calendar/live.'
          : `Connection error: ${err?.message || 'unknown'}`;
      }
    );
  }

  /* ---------------- DOM refs & state ---------------- */
  const content=document.getElementById('content');
  const filterSel=document.getElementById('filter');
  const searchInput=document.getElementById('search');
  const pivotInput=document.getElementById('pivot');
  const prevMonthBtn=document.getElementById('prevMonth');
  const nextMonthBtn=document.getElementById('nextMonth');
  const todayBtn=document.getElementById('todayBtn');
  const toastEl=document.getElementById('toast');
  const calPop=document.getElementById('calPop');
  const calLinks=document.getElementById('calLinks');

  const modal=document.getElementById('modal');
  const mRsvp=document.getElementById('mRsvp');

  let EVENTS=[]; 
  let CURRENT_LIST=[];
  let CURRENT_EVENT=null;
  let FOCUS_BEFORE=null;
  let PIVOT = startOfDay(new Date());

  /* ---------------- Utilities ---------------- */
  function showToast(text, linkHref){
    toastEl.innerHTML = linkHref ? `${text} <a href="${linkHref}" target="_blank" rel="noopener">Open</a>` : text;
    toastEl.classList.add('show');
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>toastEl.classList.remove('show'), 2200);
  }
  function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
  function toDateInput(d){ const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`; }
  function isoLocal(d){ const x=new Date(d); const pad=n=>String(n).padStart(2,'0'); return `${x.getFullYear()}-${pad(x.getMonth()+1)}-${pad(x.getDate())}T${pad(x.getHours())}:${pad(x.getMinutes())}`; }
  function fmtICS(dt){ return new Date(dt).toISOString().replace(/[-:]/g,'').split('.')[0]+'Z'; }
  function sameDay(a,b){ return a.getFullYear()==b.getFullYear() && a.getMonth()==b.getMonth() && a.getDate()==b.getDate(); }
  function fmtDate(d){ return new Date(d).toLocaleString([], {dateStyle:'medium', timeStyle:'short'}); }
  function formatRange(a,b){ const A=new Date(a), B=new Date(b); const same=sameDay(A,B); return same? `${A.toLocaleDateString([], {weekday:'short', month:'short', day:'numeric'})} • ${A.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'})}–${B.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'})}` : `${fmtDate(a)} – ${fmtDate(b)}`; }
  function placeholder(seed){ return 'https://picsum.photos/seed/'+encodeURIComponent(seed||'event')+'/600/300'; }
  function escapeHtml(s){return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

  async function copyTextToClipboard(text){
    try{
      if(navigator.clipboard && window.isSecureContext){
        await navigator.clipboard.writeText(text);
        return true;
      }
    }catch(e){ /* fall back */ }
    // Fallback (iOS/older browsers)
    const ta=document.createElement('textarea');
    ta.value=text;
    ta.setAttribute('readonly','');
    ta.style.position='fixed';
    ta.style.top='-9999px';
    document.body.appendChild(ta);
    // iOS selection hack
    if (/ipad|iphone|ipod/i.test(navigator.userAgent)) {
      const range=document.createRange(); range.selectNodeContents(ta);
      const sel=window.getSelection(); sel.removeAllRanges(); sel.addRange(range);
      ta.setSelectionRange(0, 999999);
    } else {
      ta.select();
    }
    let ok=false;
    try{ ok=document.execCommand('copy'); }catch(e){ ok=false; }
    document.body.removeChild(ta);
    return ok;
  }

  /* ---------------- Pivot & controls ---------------- */
  function setPivot(d){
    PIVOT = startOfDay(d);
    pivotInput.value = toDateInput(PIVOT);
    render();
    const u=new URL(location.href);
    u.searchParams.set('d', toDateInput(PIVOT));
    history.replaceState(null,'',u.toString());
  }
  pivotInput.onchange=()=>{ if(pivotInput.value){ setPivot(new Date(pivotInput.value)); } };
  prevMonthBtn.onclick=()=>{ const d=new Date(PIVOT.getFullYear(), PIVOT.getMonth()-1, PIVOT.getDate()); setPivot(d); };
  nextMonthBtn.onclick=()=>{ const d=new Date(PIVOT.getFullYear(), PIVOT.getMonth()+1, PIVOT.getDate()); setPivot(d); };
  todayBtn.onclick=()=> setPivot(new Date());

  /* ---------------- Live data ---------------- */
  subscribeEvents((evs, updated)=>{
    EVENTS = evs;
    buildFilters();

    const qs = new URLSearchParams(location.search);
    const d = qs.get('d') || qs.get('date');
    if(d && !pivotInput.value){ setPivot(new Date(d)); } else if(!pivotInput.value){ setPivot(new Date()); }

    render();

    const id = qs.get('e') || qs.get('event');
    if (id) {
      const list = activeEvents('all'); 
      const match = list.find(x=> (x.id||'') === id);
      if (match) openModal(match, list);
    }
  });

  function buildFilters(){
    const keep = filterSel.value;
    filterSel.innerHTML = '<option value="">All categories</option>';
    const cats=[...new Set((EVENTS||[]).map(e=>e.category).filter(Boolean))].sort();
    cats.forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;filterSel.appendChild(o);});
    filterSel.value = keep && cats.includes(keep) ? keep : '';
  }
  filterSel.onchange=render; searchInput.oninput=render;

  /* ---------------- Data selection ---------------- */
  function globalRange(events){
    if(!events || !events.length) return [new Date(Date.now()-30*864e5), new Date(Date.now()+2*365*864e5)];
    let min=Infinity, max=0;
    events.forEach(e=>{
      const s=+new Date(e.start||Date.now()); if(s<min) min=s;
      let m=s; const r=parseRRULE(e.rrule||'');
      if(r.UNTIL){ m=+icsToDate(r.UNTIL); } else { m = s + 180*864e5; }
      if(m>max) max=m;
    });
    const pad=14*864e5; return [new Date(min-pad), new Date(max+pad)];
  }
  function activeEvents(scope){
    const q=(searchInput.value||'').trim();
    const cat=filterSel.value;

    if (scope==='all'){
      const [start,end]=globalRange(EVENTS);
      let list=expandRepeats(EVENTS, start, end);
      if(cat) list=list.filter(e=>(e.category||'')===cat);
      if(q) list = fuzzyFilter(q, list);
      return list.sort((a,b)=> new Date(a.start)-new Date(b.start));
    }

    if(q){
      const [start,end]=globalRange(EVENTS);
      let list=expandRepeats(EVENTS, start, end);
      if(cat) list=list.filter(e=>(e.category||'')===cat);
      list = fuzzyFilter(q, list);
      return list.sort((a,b)=> new Date(a.start)-new Date(b.start));
    }

    const endCap = new Date(PIVOT.getFullYear()+3, PIVOT.getMonth(), PIVOT.getDate());
    let list=expandRepeats(EVENTS, PIVOT, endCap);
    if(cat) list=list.filter(e=>(e.category||'')===cat);
    return list.sort((a,b)=> new Date(a.start)-new Date(b.start));
  }

  function render(){ 
    const list=activeEvents(); 
    CURRENT_LIST = list.slice();
    const grid=document.createElement('div'); grid.className='pinboard'; 

    const in7=new Date(PIVOT); in7.setDate(PIVOT.getDate()+7);
    const in60 = new Date(PIVOT); in60.setDate(PIVOT.getDate()+60);

    const buckets = [
      {label:'This week', test:e=>new Date(e.start)<=in7},
      {label:'Next 60 days', test:e=>new Date(e.start)>in7 && new Date(e.start)<in60},
      {label:'Later', test:e=>new Date(e.start)>=in60},
    ];

    buckets.forEach(b=>{
      const items=list.filter(b.test);
      if(items.length){
        const h=document.createElement('h3'); h.className='group'; h.textContent=b.label;
        grid.appendChild(h);
        items.forEach(e=>grid.appendChild(card(e)));
      }
    });

    content.innerHTML=''; 
    content.appendChild(list.length? grid : emptyState()); 
  }

  function emptyState(){ const d=document.createElement('div'); d.className='no-results'; d.textContent='No events found for this date/search.'; return d; }

  function card(e){ 
    const k=document.createElement('article'); k.className='card'; 
    const img=document.createElement('img'); img.loading='lazy'; img.src=e.image||placeholder(e.title); k.appendChild(img); 
    const box=document.createElement('div'); box.className='pad'; k.appendChild(box); 
    const h=document.createElement('h3'); h.textContent=e.title; box.appendChild(h); 
    const p=document.createElement('div'); p.className='mini'; p.textContent=formatRange(e.start,e.end||e.start); box.appendChild(p); 
    const cat=document.createElement('span'); cat.className='pill'; cat.textContent=e.category||'General'; box.appendChild(cat); 
    const d=document.createElement('p'); d.className='clamp'; d.textContent=e.description||''; box.appendChild(d); 
    const a=document.createElement('a'); a.href='#'; a.textContent='Details'; a.onclick=(ev)=>{ev.preventDefault(); openModal(e, CURRENT_LIST);}; box.appendChild(a); 
    return k; 
  }

  /* ---------------- Modal with action bar ---------------- */
  function openModal(e, list){
    CURRENT_LIST = list || activeEvents('all');
    CURRENT_EVENT = e;
    FOCUS_BEFORE = document.activeElement;

    document.getElementById('mTitle').textContent=e.title;
    document.getElementById('mWhen').textContent=formatRange(e.start,e.end||e.start);

    const img=document.getElementById('mImg');
    if(e.image){ img.src=e.image; img.style.display='block'; } else img.style.display='none';

    document.getElementById('mDesc').textContent = e.description || '';

    // Location is a clickable map link (placeUrl wins)
    const where=document.getElementById('mWhere');
    const placeHref = e.placeUrl ? e.placeUrl :
      (e.location ? 'https://www.google.com/maps/search/?api=1&query='+encodeURIComponent(e.location) : '');
    where.innerHTML = e.location ? `<a href="${placeHref}" target="_blank" rel="noopener">${escapeHtml(e.location)}</a>` : '';

    const vid=document.getElementById('mVideo'); vid.innerHTML=''; if(e.video){ vid.innerHTML=embedVideo(e.video); }

    // RSVP primary
    if(e.rsvp){ mRsvp.href=e.rsvp; mRsvp.style.display='inline-flex'; } else { mRsvp.style.display='none'; }

    // Wire action bar buttons
    const deep = buildDeepLink(e);
    document.getElementById('shareX').onclick   = ()=>openShare('x', deep, e);
    document.getElementById('shareFb').onclick  = ()=>openShare('fb', deep, e);
    document.getElementById('shareLi').onclick  = ()=>openShare('li', deep, e);
    document.getElementById('copyLink').onclick = async ()=>{ const ok=await copyTextToClipboard(deep); showToast(ok?'Link copied!':'Copy failed'); };
    document.getElementById('emailBtn').onclick = ()=>emailEvent(e, deep);
    document.getElementById('saveCal').onclick  = (ev)=>showCalChooser(ev.currentTarget, e, deep);

    // Deep link in URL
    if(e.id){
      const u=new URL(location.href);
      u.searchParams.set('e', e.id);
      u.searchParams.set('d', toDateInput(PIVOT));
      u.searchParams.delete('date'); u.searchParams.delete('event');
      history.replaceState(null,'',u.toString());
    }

    modal.style.display='flex';
    document.getElementById('modalContent').focus();
    document.body.style.overflow='hidden';

    window.addEventListener('keydown', onKey);
    function onKey(ev){ if(ev.key==='Escape'){ closeModal(); } }
    modal._onKey = onKey;
  }

  function closeModal(){
    hideCalChooser();
    modal.style.display='none';
    document.body.style.overflow='';
    const u=new URL(location.href); u.searchParams.delete('e'); history.replaceState(null,'',u.toString());
    if(modal._onKey){ window.removeEventListener('keydown', modal._onKey); modal._onKey=null; }
    if(FOCUS_BEFORE && FOCUS_BEFORE.focus) FOCUS_BEFORE.focus();
  }
  document.getElementById('close').onclick=closeModal;
  modal.onclick=(ev)=>{ if(ev.target===modal) closeModal(); };

  /* --------- Action bar helpers --------- */
  function buildDeepLink(e){
    const url=new URL(location.href);
    if(e.id) url.searchParams.set('e', e.id);
    url.searchParams.set('d', toDateInput(PIVOT));
    url.searchParams.delete('date'); url.searchParams.delete('event');
    return url.toString();
  }
  function openShare(network, link, e){
    const text = encodeURIComponent((e.title||'Event') + ' – ' + formatRange(e.start, e.end||e.start));
    let href='#';
    if(network==='x'){
      href = `https://twitter.com/intent/tweet?text=${text}&url=${encodeURIComponent(link)}`;
    }else if(network==='fb'){
      href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}`;
    }else if(network==='li'){
      href = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(link)}`;
    }
    window.open(href,'_blank','noopener,noreferrer,width=720,height=600');
  }
  function emailEvent(e, link){
    const subject = encodeURIComponent(e.title||'Event');
    const body = encodeURIComponent(`${e.title||'Event'}\n${formatRange(e.start,e.end||e.start)}\n${e.location||''}\n\n${e.description||''}\n\nMore info: ${link}`);
    location.href = `mailto:?subject=${subject}&body=${body}`;
  }

  // Calendar chooser (Google, Apple, Outlook desktop, Outlook.com, Yahoo, Other/ICS)
  function showCalChooser(anchor, e){
    const items = [
      ['Google', googleCalLink(e)],
      ['Apple',  makeICSUrl(e, true)],
      ['Outlook', makeICSUrl(e, true)],
      ['Outlook.com', outlookLiveLink(e)],
      ['Yahoo', yahooCalLink(e)],
      ['Other (.ics)', makeICSUrl(e, true)]
    ];
    calLinks.innerHTML='';
    items.forEach(([label, href])=>{
      const a=document.createElement('a'); a.textContent=label; a.href=href;
      if(href.startsWith('data:') || href.startsWith('blob:')) a.setAttribute('download',(e.title||'event')+'.ics');
      else { a.target='_blank'; a.rel='noopener'; }
      calLinks.appendChild(a);
    });

    const r = anchor.getBoundingClientRect(), margin=8, width=320, estH=160;
    let top = r.bottom + margin, left = r.right - width;
    if (top + estH > window.innerHeight) top = r.top - estH - margin;
    left = Math.max(8, Math.min(left, window.innerWidth - width - 8));
    calPop.style.top = `${top}px`; calPop.style.left = `${left}px`; calPop.style.width=`${width}px`;
    calPop.classList.add('open');

    window.addEventListener('click', onDocClick);
    function onDocClick(ev){ if(!calPop.contains(ev.target) && ev.target!==anchor){ hideCalChooser(); window.removeEventListener('click', onDocClick); } }
  }
  function hideCalChooser(){ calPop.classList.remove('open'); }

  /* --------- Links for calendar providers --------- */
  function googleCalLink(e){
    const base='https://calendar.google.com/calendar/render?action=TEMPLATE';
    const text='&text='+encodeURIComponent(e.title||'Event');
    const dates='&dates='+fmtICS(e.start)+'/'+fmtICS(e.end||e.start);
    const details=e.description? '&details='+encodeURIComponent(e.description):'';
    const location=e.location? '&location='+encodeURIComponent(e.location):'';
    return base+text+dates+details+location;
  }
  function outlookLiveLink(e){
    const base='https://outlook.live.com/calendar/0/deeplink/compose?path=/calendar/action/compose&rru=addevent';
    const subject='&subject='+encodeURIComponent(e.title||'Event');
    const start='&startdt='+encodeURIComponent(new Date(e.start).toISOString());
    const end='&enddt='+encodeURIComponent(new Date(e.end||e.start).toISOString());
    const body=e.description? '&body='+encodeURIComponent(e.description):'';
    const location=e.location? '&location='+encodeURIComponent(e.location):'';
    return base+subject+start+end+body+location;
  }
  function yahooCalLink(e){
    const s=new Date(e.start), e2=new Date(e.end||e.start);
    const durMinutes=Math.max(30, Math.round((e2-s)/60000));
    const dur=`${String(Math.floor(durMinutes/60)).padStart(2,'0')}${String(durMinutes%60).padStart(2,'0')}`;
    const base='https://calendar.yahoo.com/?v=60&view=d&type=20';
    const st='&st='+fmtICS(s).replace(/Z$/,'Z');
    const title='&title='+encodeURIComponent(e.title||'Event');
    const desc=e.description? '&desc='+encodeURIComponent(e.description):'';
    const inLoc=e.location? '&in_loc='+encodeURIComponent(e.location):'';
    return base+title+st+'&dur='+dur+desc+inLoc;
  }
  function makeICSUrl(e, asBlob){
    const ics = singleICS(e);
    if(asBlob){
      const blob=new Blob([ics],{type:'text/calendar'});
      return URL.createObjectURL(blob);
    }
    return 'data:text/calendar;charset=utf-8,'+encodeURIComponent(ics);
  }

  /* ---------------- Embeds & helpers ---------------- */
  function embedVideo(url){
    if(/youtu\.be|youtube\.com/.test(url)){
      const id=(url.match(/[?&]v=([^&]+)/)||url.match(/youtu\.be\/([^?]+)/)||[])[1]||'';
      return id? `<div style="position:relative;padding-top:56.25%"><iframe src="https://www.youtube.com/embed/${id}" allowfullscreen style="position:absolute;inset:0;width:100%;height:100%;border:0"></iframe></div>`:'';
    }
    if(/vimeo\.com/.test(url)){
      const id=(url.match(/vimeo\.com\/(\d+)/)||[])[1]||'';
      return id? `<div style="position:relative;padding-top:56.25%"><iframe src="https://player.vimeo.com/video/${id}" allowfullscreen style="position:absolute;inset:0;width:100%;height:100%;border:0"></iframe></div>`:'';
    }
    return '';
  }
  function escapeICS(s){return String(s||'').replace(/[\\;,\n]/g, m => ({"\\":"\\\\",";":"\\;",",":"\\,","\n":"\\n"}[m]));}
  function singleICS(e){
    const lines=[`BEGIN:VCALENDAR`,`VERSION:2.0`,`PRODID:-//BASIC//Calendar//EN`,`BEGIN:VEVENT`];
    lines.push('UID:'+(e.id||('ev_'+Date.now())));
    lines.push('SUMMARY:'+escapeICS(e.title||''));
    if(e.description) lines.push('DESCRIPTION:'+escapeICS(e.description));
    if(e.location) lines.push('LOCATION:'+escapeICS(e.location));
    if(e.start) lines.push('DTSTART:'+fmtICS(e.start));
    if(e.end)   lines.push('DTEND:'+fmtICS(e.end||e.start));
    if(e.rrule) lines.push('RRULE:'+e.rrule);
    lines.push('END:VEVENT','END:VCALENDAR');
    return lines.join('\n');
  }
  function parseAttachment(s){
    if(!s) return {href:'#',label:'Attachment'};
    const parts = s.split('|');
    if(parts.length>1) return {href:parts[0], label:parts.slice(1).join('|')};
    try{
      const u=new URL(s);
      const name=(u.pathname.split('/').pop()||'').replace(/[-_]/g,' ').replace(/\.[a-z0-9]+$/i,'');
      const host=u.hostname.replace(/^www\./,'');
      return {href:s,label: name? `${name} — ${host}` : host};
    }catch{return {href:s,label:s.replace(/^https?:\/\//,'')}}
  }
  function fuzzyFilter(query, list){
    if(!query.trim()) return list;
    const fuse = new Fuse(list, { includeScore:true, threshold:0.38, ignoreLocation:true, minMatchCharLength:2, keys:['title','description','category','location'] });
    return fuse.search(query).map(r=>r.item);
  }
  function parseRRULE(s){ const r={}; (s||'').split(';').forEach(p=>{ const [k,v]=p.split('='); if(k) r[k]=v; }); return r; }
  function icsToDate(s){ const y=+s.slice(0,4), m=+s.slice(4,6)-1, d=+s.slice(6,8), hh=+s.slice(9,11), mm=+s.slice(11,13); return new Date(y,m,d,hh,mm); }
  function overlaps(e, start, end){ const A=new Date(e.start), B=new Date(e.end||e.start); return B>=start && A<=end; }
  function expandRepeats(list, rangeStart, rangeEnd){
    const out=[]; list.forEach(e=>{
      if(!e.rrule){ if(overlaps(e,rangeStart,rangeEnd)) out.push(e); return; }
      const rule=parseRRULE(e.rrule); if(!rule.FREQ){ if(overlaps(e,rangeStart,rangeEnd)) out.push(e); return; }
      const baseStart=new Date(e.start); const baseEnd=new Date(e.end||e.start);
      const until = rule.UNTIL? icsToDate(rule.UNTIL): new Date(rangeEnd);
      const interval = parseInt(rule.INTERVAL||'1',10);
      const byday = (rule.BYDAY||'').split(',').filter(Boolean);
      let d=new Date(baseStart);
      while(d<=rangeEnd && d<=until){
        if(rule.FREQ==='WEEKLY'){
          const weekStart=new Date(d);
          ['SU','MO','TU','WE','TH','FR','SA'].forEach((wd,idx)=>{
            if(!byday.length || byday.includes(wd)){
              const occ=new Date(weekStart); occ.setDate(weekStart.getDate()-weekStart.getDay()+idx);
              occ.setHours(baseStart.getHours(), baseStart.getMinutes(), 0, 0);
              const occEnd=new Date(occ.getTime() + (baseEnd - baseStart));
              if(occ>=rangeStart && occ<=rangeEnd && occ<=until){ out.push({...e,start:isoLocal(occ),end:isoLocal(occEnd)}); }
            }
          });
          d.setDate(d.getDate()+7*interval);
        } else if(rule.FREQ==='DAILY'){
          const occ=new Date(d); occ.setHours(baseStart.getHours(), baseStart.getMinutes(), 0, 0);
          if(occ>=rangeStart && occ<=rangeEnd) out.push({...e,start:isoLocal(occ),end:isoLocal(new Date(occ.getTime()+(baseEnd-baseStart)))});
          d.setDate(d.getDate()+interval);
        } else if(rule.FREQ==='MONTHLY'){
          const occ=new Date(d); occ.setHours(baseStart.getHours(), baseStart.getMinutes(), 0, 0);
          if(occ>=rangeStart && occ<=rangeEnd) out.push({...e,start:isoLocal(occ),end:isoLocal(new Date(occ.getTime()+(baseEnd-baseStart)))});
          d = new Date(d.getFullYear(), d.getMonth()+interval, d.getDate(), d.getHours(), d.getMinutes());
        } else if(rule.FREQ==='YEARLY'){
          const occ=new Date(d); occ.setHours(baseStart.getHours(), baseStart.getMinutes(), 0, 0);
          if(occ>=rangeStart && occ<=rangeEnd) out.push({...e,start:isoLocal(occ),end:isoLocal(new Date(occ.getTime()+(baseEnd-baseStart)))});
          d = new Date(d.getFullYear()+interval, d.getMonth(), d.getDate(), d.getHours(), d.getMinutes());
        } else { if(overlaps(e,rangeStart,rangeEnd)) out.push(e); break; }
      }
    }); return out;
  }
</script>
</body>
</html>
